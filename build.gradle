plugins {
    id 'java'
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.0.13'
}

// Read version from version.txt
def versionFile = file('version.txt')
def properties = new Properties()
properties.load(new FileInputStream(versionFile))
String projectVersion = properties.getProperty('VERSION')

group = 'org.homeunix.thecave'
version = projectVersion
sourceCompatibility = '17'
targetCompatibility = '17'

description = 'Buddi - Personal budget software for the rest of us'

javafx {
    version = '21.0.1'
    modules = [ 'javafx.controls', 'javafx.fxml', 'javafx.graphics' ]
}

application {
    mainClassName = 'org.homeunix.thecave.buddi.BuddiFX'
    applicationName = 'Buddi'
}

repositories {
    mavenCentral()
    flatDir {
        dirs 'lib'
    }
}

// Dependencies from lib directory
dependencies {
    // Include all jars in lib directory
    implementation fileTree(dir: 'lib', include: ['*.jar'])
    
    // Utility dependencies
    implementation name: 'org.json-2.0'
    
    // Test dependencies
    testImplementation 'org.junit.jupiter:junit-jupiter:5.9.2'
    testImplementation 'org.mockito:mockito-core:5.3.1'
    testImplementation 'org.mockito:mockito-junit-jupiter:5.3.1'
    testImplementation 'org.testfx:testfx-core:4.0.16-alpha'
    testImplementation 'org.testfx:testfx-junit5:4.0.16-alpha'
    
    // JUnit 4 support for legacy tests
    testImplementation 'junit:junit:4.13.2'
    testRuntimeOnly 'org.junit.vintage:junit-vintage-engine:5.9.2'
    
    // Quaqua L&F for OSX (not included as a JAR, but handled separately)
    // implementation name: 'quaqua-8.0'
}

// Compile configuration with all classpath entries
tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
    // Suppress all lint warnings for legacy code (pre-dates modern Java practices)
    options.compilerArgs << '-Xlint:none'
    doFirst {
        classpath += fileTree(dir: 'lib', include: '*.jar')
    }
}

// Custom jar task that creates a fat jar (includes all dependencies)
jar {
    manifest {
        attributes(
            'Main-Class': application.mainClass,
            'Implementation-Title': description,
            'Implementation-Version': version,
            'Created-By': 'Gradle',
            'Build-Date': new Date().format('yyyy-MM-dd HH:mm:ss')
        )
    }

    // Include all dependency classes and resources
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }

    // Include version, images, and documentation
    from('.') {
        include 'version.txt'
    }

    from('img') {
        include '*.jpg'
        include '*.png'
        include '*.gif'
    }

    from('docs') {
        include '**/*.rtf'
        include '**/*.txt'
        include 'Licenses/**'
    }

    // Exclude Quaqua native libraries and OSX-specific files
    exclude 'libquaqua*'
    exclude '**/META-INF/maven/**'
    exclude '**/META-INF/services/**'
    duplicatesStrategy 'exclude'  // Ignore duplicates (etc resources already included via sourceSets)
}

// Run configuration with special VM options for legacy compatibility
run {
    args = []
    workingDir = projectDir  // Run from project root to find etc/Languages/ and other resources
    systemProperties = [
        'os.name': System.getProperty('os.name'),  // Use actual OS
    ]
    jvmArgs = [
        '--add-opens', 'java.desktop/com.apple.eawt=ALL-UNNAMED',
        '-Xmx512m'
    ]
}

// Source set configuration
sourceSets {
    main {
        java {
            srcDirs = ['src']
        }
        resources {
            srcDirs = ['etc']  // Include etc directory (contains Languages, css, etc.)
        }
    }
    test {
        java {
            srcDirs = ['junit']
        }
    }
}

// Custom tasks for running tests from junit directory
task runViewModelTests {
    dependsOn 'testClasses'
    doLast {
        javaexec {
            classpath = sourceSets.test.runtimeClasspath + sourceSets.main.runtimeClasspath + files('lib')
            main = 'org.homeunix.thecave.buddi.test.viewmodel.MyAccountsViewModelTest'
            systemProperty 'os.name', System.getProperty('os.name')
        }
    }
}

// Platform-specific package tasks
task packageWindows {
    dependsOn 'jar'
    group = 'Build Distributions'
    description = 'Creates Windows installer'
    doLast {
        println "Windows packaging would require Launch4J and IzPack"
        println "Jar artifact created at: build/libs/Buddi-${version}.jar"
    }
}

task packageOSX {
    dependsOn 'jar'
    group = 'Build Distributions'
    description = 'Creates OSX .dmg package'
    doLast {
        println "OSX packaging would require JarBundler"
        println "Jar artifact created at: build/libs/Buddi-${version}.jar"
    }
}

task packageLinuxDebian {
    dependsOn 'jar'
    group = 'Build Distributions'
    description = 'Creates Debian .deb package'
    doLast {
        println "Debian packaging would require jdeb plugin"
        println "Jar artifact created at: build/libs/Buddi-${version}.jar"
    }
}

task packageLinuxGeneric {
    dependsOn 'jar'
    group = 'Build Distributions'
    description = 'Creates generic Linux package'
    doLast {
        println "Generic Linux package created"
        println "Jar artifact created at: build/libs/Buddi-${version}.jar"
    }
}

// Documentation tasks
task printProjectInfo {
    group = 'Help'
    description = 'Prints project information'
    doLast {
        println """
        ========================================
        Buddi Build Information
        ========================================
        Project Name: ${project.name}
        Version: ${version}
        Group: ${group}
        Source Compatibility: ${sourceCompatibility}
        Target Compatibility: ${targetCompatibility}
        Main Class: ${application.mainClass}
        
        Available Gradle Tasks:
        - gradle build           : Build the project
        - gradle jar             : Create executable jar
        - gradle run             : Run the application
        - gradle clean           : Clean build artifacts
        - gradle runViewModelTests : Run ViewModel tests
        
        Platform-Specific Packaging:
        - gradle packageWindows  : Windows executable (requires Launch4J)
        - gradle packageOSX      : OSX .dmg package (requires JarBundler)
        - gradle packageLinuxDebian : Debian .deb package (requires jdeb)
        - gradle packageLinuxGeneric : Generic Linux .tgz package
        
        ========================================
        """.stripIndent()
    }
}
